#!/usr/bin/env bash
# EDITOR — Launch the Custodian Editor (project picker + Claude session)
# Widget entry point for Wave Terminal
# Works on both Windows (Git Bash) and WSL (via SSH from laptop)

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
WORKBENCH_DIR="$(dirname "$SCRIPT_DIR")"

# Use venv python directly — no 'source activate' needed
# This works in Wave's cmd controller which doesn't support 'source'
VENV_PYTHON="$HOME/.custodian-venv/bin/python3"
LOCAL_PYTHON="$WORKBENCH_DIR/custodian/.venv/bin/python3"
LOCAL_PYTHON_WIN="$WORKBENCH_DIR/custodian/.venv/Scripts/python.exe"

if [ -x "$VENV_PYTHON" ]; then
    PYTHON="$VENV_PYTHON"
elif [ -x "$LOCAL_PYTHON" ]; then
    PYTHON="$LOCAL_PYTHON"
elif [ -x "$LOCAL_PYTHON_WIN" ]; then
    PYTHON="$LOCAL_PYTHON_WIN"
else
    PYTHON="python3"
fi

# Ensure DB exists
if [ ! -f "$WORKBENCH_DIR/custodian/custodian.db" ]; then
    "$PYTHON" "$WORKBENCH_DIR/custodian/init_db.py"
fi

cd "$WORKBENCH_DIR"
exec "$PYTHON" custodian/editor.py
