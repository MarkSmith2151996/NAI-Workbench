#!/usr/bin/env bash
# claude-session — Project picker that launches Claude in the selected dir
set -euo pipefail

PROJECTS_DIR="$HOME/projects"

echo "╔══════════════════════════════════════╗"
echo "║       CLAUDE — PROJECT PICKER        ║"
echo "╚══════════════════════════════════════╝"
echo ""

# --- Build project list ---
projects=()
for d in "$PROJECTS_DIR"/*/; do
  [ -d "$d" ] && projects+=("$(basename "$d")")
done

if [ ${#projects[@]} -eq 0 ]; then
  echo "No projects found in $PROJECTS_DIR"
  exit 1
fi

for i in "${!projects[@]}"; do
  name="${projects[$i]}"
  dir="$PROJECTS_DIR/$name"

  # Detect stack type
  if [ -f "$dir/package.json" ]; then
    stack="Node"
  elif [ -f "$dir/pyproject.toml" ] || [ -f "$dir/requirements.txt" ] || [ -f "$dir/setup.cfg" ]; then
    stack="Python"
  elif ls "$dir"/bin/* &>/dev/null; then
    stack="Bash"
  else
    stack="Other"
  fi

  # Git info
  branch=""
  changed=""
  if [ -d "$dir/.git" ]; then
    branch=$(git -C "$dir" branch --show-current 2>/dev/null || echo "")
    change_count=$(git -C "$dir" status --porcelain 2>/dev/null | wc -l | tr -d ' ')
    if [ "$change_count" -gt 0 ]; then
      changed="  ${change_count} changed"
    fi
  fi

  printf "  %d) %-20s (%-6s)  %-8s%s\n" "$((i + 1))" "$name" "$stack" "$branch" "$changed"
done

echo ""
read -rp "Pick a project [1-${#projects[@]}]: " pick
pick=$((pick - 1))

if [ "$pick" -lt 0 ] || [ "$pick" -ge "${#projects[@]}" ]; then
  echo "Invalid selection."
  exit 1
fi

PROJECT="${projects[$pick]}"
PROJECT_DIR="$PROJECTS_DIR/$PROJECT"

echo ""
echo "Launching Claude in $PROJECT_DIR..."
echo ""

cd "$PROJECT_DIR"
exec claude
