#!/usr/bin/env bash
set -euo pipefail

PROJECT_DIR="${1:-.}"
APP_URL="${2:-}"

echo "=== SECURITY GATE: $PROJECT_DIR ==="

echo "[Gate 1/5] Secret detection..."
gitleaks detect --source "$PROJECT_DIR" --no-banner

echo "[Gate 2/5] Static analysis..."
semgrep scan --config auto --error "$PROJECT_DIR"

echo "[Gate 3/5] Dependency vulnerabilities..."
trivy fs --severity HIGH,CRITICAL --exit-code 1 "$PROJECT_DIR"

if [ -n "$APP_URL" ]; then
  echo "[Gate 4/5] Dynamic security testing..."
  docker run --rm -t ghcr.io/zaproxy/zaproxy:stable \
    zap-baseline.py -t "$APP_URL"
else
  echo "[Gate 4/5] No app URL, skipping DAST"
fi

if [ -n "$APP_URL" ]; then
  echo "[Gate 5/5] Stress test..."
  k6 run --vus 50 --duration 30s - <<SCRIPT
  import http from "k6/http";
  export default function () {
    http.get("$APP_URL");
  }
SCRIPT
else
  echo "[Gate 5/5] No app URL, skipping stress test"
fi

echo "=== ALL GATES PASSED ==="
